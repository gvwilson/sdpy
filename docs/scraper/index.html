<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/x-icon" href="../favicon.ico">
<link rel="stylesheet" href="../mccole.css">
<link rel="stylesheet" href="../tango.css">
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']]
    }
  };
</script>
<script
  type="text/javascript"
  id="MathJax-script"
  async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

    <title>Software Design in Python</title>
  </head>
  <body>
    <div class="row">
      <div class="column">
        <h2><a href="../">SDPy</a></h2>
        <ol class="toc-chapter">
  
  <li>
    <a href="../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../tester/">
      A Testing Framework
    </a>
  </li>
  
  <li>
    <a href="../interpreter/">
      Interpreter
    </a>
  </li>
  
  <li>
    <a href="../dataframe/">
      A Dataframe
    </a>
  </li>
  
  <li>
    <a href="../backup/">
      Versioned File Backups
    </a>
  </li>
  
  <li>
    <a href="../pipeline/">
      A Pipeline Runner
    </a>
  </li>
  
  <li>
    <a href="../builder/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../matching/">
      Matching Regular Expressions
    </a>
  </li>
  
  <li>
    <a href="../parser/">
      A Regular Expression Parser
    </a>
  </li>
  
  <li>
    <a href="../scraper/">
      <strong>Scraping Data</strong>
    </a>
  </li>
  
  <li>
    <a href="../server/">
      A Web Server
    </a>
  </li>
  
  <li>
    <a href="../filecache/">
      A File Cache
    </a>
  </li>
  
  <li>
    <a href="../database/">
      Key-Value Store
    </a>
  </li>
  
  <li>
    <a href="../persistence/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Storage
    </a>
  </li>
  
  <li>
    <a href="../templating/">
      HTML Templating
    </a>
  </li>
  
  <li>
    <a href="../packman/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../linter/">
      A Style Checker
    </a>
  </li>
  
  <li>
    <a href="../docgen/">
      A Documentation Generator
    </a>
  </li>
  
  <li>
    <a href="../codegen/">
      A Code Generator
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      Debugger
    </a>
  </li>
  
  <li>
    <a href="../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../links/">
      Links
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

      </div>
      <div class="column bordered">
        <main>
	  
          <h1>Scraping Data</h1>
	  
          
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  


	  
  

  

  
  <p class="definitions">
    Terms defined:
    <a class="gl-ref" href="../glossary/#bin" markdown="1">bin (in histogram)</a>, <a class="gl-ref" href="../glossary/#box_and_whisker_plot" markdown="1">box and whisker plot</a>, <a class="gl-ref" href="../glossary/#build_tool" markdown="1">build tool</a>, <a class="gl-ref" href="../glossary/#data_manifest" markdown="1">data manifest</a>, <a class="gl-ref" href="../glossary/#descriptive_statistics" markdown="1">descriptive statistics</a>, <a class="gl-ref" href="../glossary/#docstring" markdown="1">docstring</a>, <a class="gl-ref" href="../glossary/#escape_character" markdown="1">escape character</a>, <a class="gl-ref" href="../glossary/#gzip" markdown="1">gzip compression</a>, <a class="gl-ref" href="../glossary/#iqr" markdown="1">inter-quartile range</a>, <a class="gl-ref" href="../glossary/#iso_date_format" markdown="1">ISO date format</a>, <a class="gl-ref" href="../glossary/#main_driver" markdown="1">main driver</a>, <a class="gl-ref" href="../glossary/#mean" markdown="1">mean</a>, <a class="gl-ref" href="../glossary/#median" markdown="1">median</a>, <a class="gl-ref" href="../glossary/#na" markdown="1">NA (Not Available)</a>, <a class="gl-ref" href="../glossary/#build_prerequisite" markdown="1">prerequisite (in build)</a>, <a class="gl-ref" href="../glossary/#quartile" markdown="1">quartile</a>, <a class="gl-ref" href="../glossary/#regular_expression" markdown="1">regular expression</a>, <a class="gl-ref" href="../glossary/#build_rule" markdown="1">rule (in build)</a>, <a class="gl-ref" href="../glossary/#standard_deviation" markdown="1">standard deviation</a>, <a class="gl-ref" href="../glossary/#tar" markdown="1">tar</a>, <a class="gl-ref" href="../glossary/#build_target" markdown="1">target (in build)</a>, <a class="gl-ref" href="../glossary/#throttle" markdown="1">throttle</a>, <a class="gl-ref" href="../glossary/#tidy_data" markdown="1">tidy data</a>, <a class="gl-ref" href="../glossary/#variance" markdown="1">variance</a>, <a class="gl-ref" href="../glossary/#violin_plot" markdown="1">violin plot</a>, <a class="gl-ref" href="../glossary/#wheel" markdown="1">wheel (Python)</a>
  </p>
  

  

  

  


          <p>This lesson will show how to scrape data from the web.
We'll tackle the problem in three steps:
processing HTML,
getting HTML pages from the web,
and scaling up.</p>
<h2 id="scraper-html">Section 10.1: Processing HTML</h2>
<p>Python's standard library includes an HTML parser called <code>html.parser</code>,
but since the HTML found in the wild often doesn't comply with standards,
most people use a more resilient library called <a href="https://beautiful-soup-4.readthedocs.io/">Beautiful Soup</a> to read pages instead.
To show how it works,
here's a short HTML page called <code>species.html</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Species Information<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Species Information<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
      All information from
      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://en.wikipedia.org/wiki/List_of_birds_of_Ontario&quot;</span><span class="p">&gt;</span>Wikipedia<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.
    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Snow goose <span class="p">&lt;</span><span class="nt">em</span><span class="p">&gt;</span>Anser caerulescens<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Mute swan <span class="p">&lt;</span><span class="nt">em</span><span class="p">&gt;</span>Cygnus olor<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Green-winged teal <span class="p">&lt;</span><span class="nt">em</span><span class="p">&gt;</span>Anas crecca<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Smew <span class="p">&lt;</span><span class="nt">em</span><span class="p">&gt;</span>Mergellus albellus<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Histrionic duck <span class="p">&lt;</span><span class="nt">em</span><span class="p">&gt;</span>Histrionicus histrionicus<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p>Let's load that page with Beautiful Soup:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span><span class="p">,</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">NavigableString</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Tag</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">depth</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
            <span class="n">show</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">NavigableString</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">string</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">depth</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;I don&#39;t know what </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2"> is&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;species.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
    <span class="n">show</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>This program's output is:</p>
<div class="highlight"><pre><span></span><code> [document] + {}
   html + {}
     == &#39;\n&#39;
     head + {}
       == &#39;\n&#39;
       title + {}
         == &#39;Species Information&#39;
       == &#39;\n&#39;
     == &#39;\n&#39;
     body + {}
       == &#39;\n&#39;
       h1 + {}
         == &#39;Species Information&#39;
       == &#39;\n&#39;
       p + {}
         == &#39;\n      All information from\n      &#39;
         a + {&#39;href&#39;: &#39;https://en.wikipedia.org/wiki/List_of_birds_of_Ontario&#39;}
           == &#39;Wikipedia&#39;
         == &#39;.\n    &#39;
       == &#39;\n&#39;
       ul + {}
         == &#39;\n&#39;
         li + {&#39;class&#39;: [&#39;species&#39;]}
           == &#39;Snow goose &#39;
           em + {}
             == &#39;Anser caerulescens&#39;
         == &#39;\n&#39;
         li + {&#39;class&#39;: [&#39;species&#39;]}
           == &#39;Mute swan &#39;
           em + {}
             == &#39;Cygnus olor&#39;
         == &#39;\n&#39;
         li + {&#39;class&#39;: [&#39;species&#39;]}
           == &#39;Green-winged teal &#39;
           em + {}
             == &#39;Anas crecca&#39;
         == &#39;\n&#39;
         li + {&#39;class&#39;: [&#39;species&#39;]}
           == &#39;Smew &#39;
           em + {}
             == &#39;Mergellus albellus&#39;
         == &#39;\n&#39;
         li + {&#39;class&#39;: [&#39;species&#39;]}
           == &#39;Histrionic duck &#39;
           em + {}
             == &#39;Histrionicus histrionicus&#39;
         == &#39;\n&#39;
       == &#39;\n&#39;
     == &#39;\n&#39;
   == &#39;\n&#39;
</code></pre></div>
<p>What it shows is that:</p>
<ul>
<li>Beautiful Soup creates a single <code>document</code> node to contain the whole document.</li>
<li>That node has a single child with the tag <code>html</code>,
   which has a <code>head</code> and a <code>body</code> node as its children.
   In between those children are some text elements holding
   the spaces and newlines we used for indentation in our document.</li>
<li>We can get the tag of a node using <code>node.name</code>
   and a dictionary of its attributes using <code>node.attrs</code>.</li>
</ul>
<p>We could find things in this tree by writing a <code>search</code> function
that recursed down through the nodes the same way that <code>show</code> does,
but this is such a common operation that Beautiful Soup provides a bunch of search functions for us:</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;species.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
    <span class="n">heading</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;h1&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">heading</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Species Information
</code></pre></div></p>
<p>Notice that the <code>.string</code> property of a node returns the text inside that node.</p>
<p>Here's a more interesting search:</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;species.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;species&quot;</span><span class="p">})</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Common,Scientific&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">species</span><span class="p">:</span>
        <span class="c1"># first child is a string</span>
        <span class="n">common</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># scientific name in &#39;em&#39;</span>
        <span class="n">scientific</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;em&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">scientific</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Common,Scientific
Snow goose,Anser caerulescens
Mute swan,Cygnus olor
Green-winged teal,Anas crecca
Smew,Mergellus albellus
Histrionic duck,Histrionicus histrionicus
</code></pre></div></p>
<p>The three most important things about this example are:</p>
<ol>
<li>
<p>We don't have to search the document ourselves:
    Beautiful Soup will find what we need.</p>
</li>
<li>
<p>But we <em>do</em> have to know how to specify what we're looking for…</p>
</li>
<li>
<p>…and the document has to be regularly structured.
    If the species' names were scattered throughout paragraphs of plain text,
    finding them would be a lot more work.</p>
</li>
</ol>
<h2 id="scraper-web">Section 10.2: Scraping the Web</h2>
<p>The Hypertext Transfer Protocol (HTTP) specifies one way that
programs can exchange data over the Internet.
HTTP is deliberately simple:
the client sends a request specifying what it wants
and the server sends some data in response.
This can be the contents of a file copied from disk,
some HTML generated dynamically,
a blob of JSON (as text),
or anything else.</p>
<p>An HTTP request is that it's just text:
any program that wants to can create one or parse one.
An absolutely minimal HTTP request has just a <em>method</em> (sometimes also called a <em>verb</em>),
a <em>URL</em>,
and a <em>protocol version</em>
on a single line separated by spaces like this:</p>
<div class="highlight"><pre><span></span><code>GET /index.html HTTP/1.1
</code></pre></div>
<p>The HTTP method is almost always either <code>GET</code> (to fetch information)
or <code>POST</code> (to submit form data or upload files).
The URL specifies what the client wants;
it is often a path to a file on disk,
such as <code>/index.html</code>,
but again,
the server can interpret it however it wants.
The HTTP version is usually "HTTP/1.0" or "HTTP/1.1";
the differences between the two don't matter to us.</p>
<p>Most real requests have a few extra lines called <em>headers</em>,
which are key value pairs like the three shown below:</p>
<div class="highlight"><pre><span></span><code>GET /index.html HTTP/1.1
Accept: text/html
Accept-Language: en, fr
If-Modified-Since: 16-May-2022
</code></pre></div>
<p>Unlike the keys in hash tables,
keys may appear any number of times in HTTP headers.
This allows a request to do things like
specify that it's willing to accept several types of content.</p>
<p>Finally,
the <em>body</em> of the request is any extra data associated with the request;
if there is a body,
the request must have a header called <code>Content-Length</code>
that tells the server how many bytes to read in the body of the request.
The body is used for submitting data via web forms,
uploading files,
and so on.
There must be a blank line between the last header and the start of the body
to signal the end of the headers.</p>
<p>An HTTP response is formatted like an HTTP request.
Its first line has the protocol,
a <em>status code</em> like 200 or 404,
and a status phrase like "OK" or "Not Found".
There are then some headers,
a blank line,
and the body of the response:</p>
<div class="highlight"><pre><span></span><code>HTTP/1.1 200 OK
Date: Thu, 16 June 2022 12:28:53 GMT
Server: minserve/2.2.14 (Linux)
Last-Modified: Wed, 15 Jun 2022 19:15:56 GMT
Content-Type: text/html
Content-Length: 53

&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;Hello, World!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div>
<p>Constructing HTTP requests is tedious,
so most people use libraries to do most of the work.
The most popular such library in Python is called <a href="https://requests.readthedocs.io/">requests</a>.
Since <code>species.html</code> is stored in a public GitHub repository,
it can be viewed online at <a href="https://gvwilson.github.io/tlscr/species.html">https://gvwilson.github.io/tlscr/species.html</a>.
Here's a program that uses requests to download and print the source:</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">URL</span> <span class="o">=</span> <span class="s2">&quot;https://gvwilson.github.io/tlscr/species.html&quot;</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;text:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>status code: 200
text:
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Species Information&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Species Information&lt;/h1&gt;
    …as previously…
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div></p>
<p>Once we have the HTML text,
we can parse it with Beautiful Soup.
We can then look for hypertext links
(i.e., elements with the <code>a</code> tag and an <code>href</code> attribute)
and download the pages that this one refers to.</p>
<h3>Exercises (for the week of July 5-12)</h3>
<p>The page <a href="https://gvwilson.github.io/tlscr/species-index.html">https://gvwilson.github.io/tlscr/species-index.html</a>
has the following content:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Species Information<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Species Information<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
      All information from
      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://en.wikipedia.org/wiki/List_of_birds_of_Ontario&quot;</span><span class="p">&gt;</span>Wikipedia<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.
    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;snow-goose.html&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;species&quot;</span><span class="p">&gt;</span>Snow goose<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;nonexistent-loon.html&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;species&quot;</span><span class="p">&gt;</span>Nonexistent loon<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;mute-swan.html&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;species&quot;</span><span class="p">&gt;</span>Mute swan<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;green-winged-teal.html&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;species&quot;</span><span class="p">&gt;</span>Green-winged teal<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;smew.html&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;species&quot;</span><span class="p">&gt;</span>Smew<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;histrionic-duck.html&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;species&quot;</span><span class="p">&gt;</span>Histrionic duck<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<ol>
<li>
<p>Modify the Python program shown earlier to download this page,
    parse it with Beautiful Soup,
    and show a list of species' names.</p>
</li>
<li>
<p>Modify the program you just wrote to download this page,
    find all the links with the class <code>"species"</code>,
    download <em>those</em> pages,
    and print the scientific name of each species.
    For reference,
    the sub-page for smews is shown below.</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Smew<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Smew<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;scientific&quot;</span><span class="p">&gt;</span>Mergellus albellus<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p>Note: you may find <code>urllib.parse</code> useful for constructing the URLs of pages.
In particular:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; from urllib.parse import urlparse
&gt;&gt;&gt; components = urlparse(&quot;https://gvwilson.github.io/tlscr/species-index.html&quot;)
&gt;&gt;&gt; components.scheme
&quot;https&quot;
&gt;&gt;&gt; components.netloc
&quot;gvwilson.github.io&quot;
&gt;&gt;&gt; components.path
&quot;/tlscr/species-index.html&quot;
</code></pre></div>
<h2 id="scraper-scale">Section 10.3: Scaling Up</h2>
<ul>
<li>The steps in most data analysis projects are:<ol>
<li>Find data</li>
<li>Collect it</li>
<li>Tidy it</li>
<li>Do calculations</li>
<li>Report results</li>
</ol>
</li>
<li>How can we make all of this easier to understand, reproduce, and extend?</li>
<li>To illustrate, let's find out how many versions of Python packages there are</li>
</ul>
<h3>Where can we get data?</h3>
<ul>
<li>Data source is simple <a href="https://pypi.org/">PyPI</a> <a href="https://pypi.org/simple/">package index page</a><ul>
<li>Has HTML links to one page per package</li>
</ul>
</li>
<li>Each package's page has links to released versions in various formats<ul>
<li>205K entries in total</li>
</ul>
</li>
<li>Some redundancy, e.g., <a class="gl-ref" href="../glossary/#wheel" markdown="1">wheels</a> and <a class="gl-ref" href="../glossary/#gzip" markdown="1">gzip'd</a> <a class="gl-ref" href="../glossary/#tar" markdown="1">tar</a> files<ul>
<li>We have to decide whether to count these separately or fold them together</li>
<li>Every statistical result is the product of many decisions</li>
<li>Different decisions produce different results</li>
</ul>
</li>
</ul>
<h3>How can we collect data from web pages?</h3>
<ul>
<li>Use the <a href="https://requests.readthedocs.io/"><code>requests</code></a> library to get page</li>
<li>HTML is very highly structured,
    so we can get away with using <a class="gl-ref" href="../glossary/#regular_expression" markdown="1">regular expressions</a> to extract fields<ul>
<li>[This is a sin][regular-expressions-html]</li>
<li>Look at better ways in an exercise</li>
</ul>
</li>
</ul>
<p title="get-index-page-initial.py"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="c1"># Match package URL in main index page.</span>
<span class="n">RE_PACKAGE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;a href=&quot;(.+?)&quot;&gt;&#39;</span><span class="p">)</span>

<span class="c1"># Match release URL in package index page.</span>
<span class="n">RE_RELEASE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;a href=&quot;.+?&quot;&gt;(.+?)&lt;/a&gt;&#39;</span><span class="p">)</span>

<span class="c1"># PyPI domain.</span>
<span class="n">DOMAIN</span> <span class="o">=</span> <span class="s1">&#39;https://pypi.org&#39;</span>


<span class="n">index_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DOMAIN</span><span class="si">}</span><span class="s1">/simple/&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Package,Releases&#39;</span><span class="p">)</span>
<span class="n">all_packages</span> <span class="o">=</span> <span class="n">RE_PACKAGE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">index_response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">all_packages</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DOMAIN</span><span class="si">}{</span><span class="n">package</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">package_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">RE_RELEASE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">package_response</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div></p>
<ul>
<li>First run crashed after a few minutes because of a missing sub-page</li>
<li>So add a check on the HTTP status codes from queries<ul>
<li>Record <a class="gl-ref" href="../glossary/#na" markdown="1"><code>NA</code></a> for those pages</li>
<li>And hope that analysis software interprets this as "not available"
    rather than Namibia or the element sodium</li>
</ul>
</li>
<li>Add some logging so that we can tell how long the program is going to take to run<ul>
<li>About 30K seconds, or 8.5 hours</li>
</ul>
</li>
</ul>
<div class="callout">
<h3>A Small Grumble</h3>
<p>Ideally, the code above would morph into the code shown below
so that you could see what was the same and what was different.
A second-best solution would be an easy way to highlight modified lines,
with an emphasis on "easy".
One day...</p>
</div>
<p title="get-index-page.py"><div class="highlight"><pre><span></span><code><span class="c1"># !/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="c1"># Match package URL in main index page.</span>
<span class="n">RE_PACKAGE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;a href=&quot;(.+?)&quot;&gt;&#39;</span><span class="p">)</span>

<span class="c1"># Match release URL in package index page.</span>
<span class="n">RE_RELEASE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;a href=&quot;.+?&quot;&gt;(.+?)&lt;/a&gt;&#39;</span><span class="p">)</span>

<span class="c1"># PyPI domain.</span>
<span class="n">DOMAIN</span> <span class="o">=</span> <span class="s1">&#39;https://pypi.org&#39;</span>


<span class="c1"># Get main index page.</span>
<span class="n">index_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DOMAIN</span><span class="si">}</span><span class="s1">/simple/&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">index_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span> \
    <span class="sa">f</span><span class="s1">&#39;Unexpected status for index page </span><span class="si">{</span><span class="n">index_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">&#39;</span>

<span class="c1"># Get sub-pages and count releases in each.</span>
<span class="n">num_seen</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Package,Releases&#39;</span><span class="p">)</span>
<span class="n">all_packages</span> <span class="o">=</span> <span class="n">RE_PACKAGE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">index_response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">all_packages</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">DOMAIN</span><span class="si">}{</span><span class="n">package</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">package_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">package_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected status for package page </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">package_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">RE_RELEASE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">package_response</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">num_seen</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_seen</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span>
        <span class="n">t_expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_packages</span><span class="p">)</span> <span class="o">*</span> <span class="n">t_elapsed</span> <span class="o">/</span> <span class="n">num_seen</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_seen</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">t_elapsed</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_packages</span><span class="p">)</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">t_expected</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</code></pre></div></p>
<ul>
<li>Still not a friendly program<ul>
<li>If several thousand people run this program at the same time it will slow PyPI down</li>
</ul>
</li>
<li>Unlikely in this case,
    but a school could easily wind up being blacklisted
    if a hundred students are grabbing data at the same time</li>
<li>Popular data sources have to manage floods of requests</li>
<li>Programs should <a class="gl-ref" href="../glossary/#throttle" markdown="1">throttle</a> their own activity</li>
</ul>
<h3>How can we report results?</h3>
<ul>
<li><a class="gl-ref" href="../glossary/#descriptive_statistics" markdown="1">Descriptive statistics</a> are key facts about data</li>
<li>The <a class="gl-ref" href="../glossary/#median" markdown="1">median</a> is the middle value<ul>
<li>If $$N$$ is odd, sort and take the middle</li>
<li>If $$N$$ is even, sort and average the two middle values</li>
</ul>
</li>
<li>The <a class="gl-ref" href="../glossary/#mean" markdown="1">mean</a> is the weighted center of the data<ul>
<li>$$ \mu = \frac{1}{N} \sum x_i $$</li>
</ul>
</li>
<li>If there are a few outliers, the mean can be very different from the median<ul>
<li>Mean of <code>[1, 2, 3, 4, 100]</code> is 22, but median is 3</li>
<li>Which is why those who have like to quote means rather than medians</li>
</ul>
</li>
<li><a class="gl-ref" href="../glossary/#variance" markdown="1">Variance</a> measures the spread of values<ul>
<li>$$ \sigma^2 = \frac{1}{N} \sigma (x_i - \mu)^2 $$</li>
<li>Squaring the differences gives extra weight to outliers...</li>
<li>...but makes variance hard to use directly, since its units are (for example) lines squared</li>
</ul>
</li>
<li>Instead, use the <a class="gl-ref" href="../glossary/#standard_deviation" markdown="1">standard deviation</a><ul>
<li>Square root of the variance, so it has the same units as the data</li>
</ul>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">datafile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">packages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">packages</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]))</span>
</code></pre></div>
{: title="version-statistics.py"}
<div class="highlight"><pre><span></span><code>python version-statistics.py release-count.csv
</code></pre></div>
<div class="highlight"><pre><span></span><code>            Releases
mean       11.236351
median      4.000000
var      2501.398099
std        50.013979
min         0.000000
max     10797.000000
</code></pre></div></p>
<ul>
<li>Half of all packages have had fewer than four releases</li>
<li>The mean is only slightly higher (1/5 of a standard deviation)</li>
<li>And yeah, a package with almost 11,000 releases will pull things up<ul>
<li><code>ccxt</code> is a cryptocurrency, so they might be using releases as ledger updates</li>
</ul>
</li>
</ul>
<h3>How can we display the results</h3>
<ul>
<li>Again, a histogram shows the distribution of values<ul>
<li>Its shape (and hence our interpretation) depends on how we <a class="gl-ref" href="../glossary/#bin" markdown="1">bin</a> the data</li>
</ul>
</li>
<li>Given how long data collection takes,
    most sensible thing is to collect the data once and write separate plotting programs to view it<ul>
<li>Provide name of data file on the command line</li>
</ul>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="n">datafile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">packages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Distribution of Releases&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">packages</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Releases&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">packages</span><span class="p">[</span><span class="s2">&quot;Releases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s1"> missing values&#39;</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">packages</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Releases&#39;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s1">&#39;figures/release-count.svg&#39;</span><span class="p">)</span>
</code></pre></div>
{: title="version-histogram.py"}
<div class="highlight"><pre><span></span><code>python version-histogram.py release-count.csv
</code></pre></div>
<div class="highlight"><pre><span></span><code>Distribution of Releases
          Package
Releases         
0.0         11721
1.0         33992
2.0         32829
3.0         14999
4.0         18339
5.0          8946
...
4505.0          1
5133.0          1
6460.0          1
10797.0         1

[561 rows x 1 columns]
14 missing values
</code></pre></div></p>
<p>{% include figure
   id="release-count"
   img="figures/release-count.svg"
   alt="FIXME"
   cap="Release Count"
   title="Histogram showing steeply declining curve from X equals 0 to X above 10,000 with peak over 200,000 at X equals 0." %}</p>
<ul>
<li>Printed output includes the value for packages with zero releases</li>
<li>But does the histogram?<ul>
<li>What does Plotly do with <code>log(0)</code>?</li>
</ul>
</li>
<li>Let's try:</li>
</ul>
<p title="version-histogram.py"><div class="highlight"><pre><span></span><code><span class="nb">slice</span> <span class="o">=</span> <span class="n">packages</span><span class="p">[</span><span class="n">packages</span><span class="p">[</span><span class="s1">&#39;Releases&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Releases&#39;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s1">&#39;figures/release-count-low.svg&#39;</span><span class="p">)</span>
</code></pre></div></p>
<p>{% include figure
   id="release-count-low"
   img="figures/release-count-low.svg"
   cap="Release Count (Low End)"
   alt="FIXME"
   title="Histogram showing smoothly declining curve from X equals 0 to X equals 100 with over 10,000 values at X equals zero and alternating high and low bars." %}</p>
<ul>
<li>It seems to include zero</li>
<li>But that double-stepping looks weird</li>
<li>
<p>Is it a plotting artifact or a result of double-counting packages that are released in multiple formats?</p>
<ul>
<li>For that, we need better data</li>
</ul>
</li>
<li>
<p>Use a <a class="gl-ref" href="../glossary/#violin_plot" markdown="1">violin plot</a> to get a feel for the shape of the data</p>
</li>
</ul>
<p title="version-other-plots.py"><div class="highlight"><pre><span></span><code><span class="n">datafile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">packages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
<span class="nb">slice</span> <span class="o">=</span> <span class="n">packages</span><span class="p">[</span><span class="n">packages</span><span class="p">[</span><span class="s1">&#39;Releases&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">]</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">violin</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Releases&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s1">&#39;figures/release-count-violin.svg&#39;</span><span class="p">)</span>
</code></pre></div></p>
<p>{% include figure
   id="release-count-violin"
   img="figures/release-count-violin.svg"
   cap="Violin Plot (Low End)"
   alt="FIXME"
   title="Symmetric vertical violin plot with almost all values in bulge at bottom end." %}</p>
<ul>
<li>Can also use a <a class="gl-ref" href="../glossary/#box_and_whisker_plot" markdown="1">box-and-whisker plot</a><ul>
<li>Lines show minimum, first <a class="gl-ref" href="../glossary/#quartile" markdown="1">quartile</a>, median, third quartile, and maximum</li>
<li>Box shows first quartile to third quartile (so half the data lies inside the box)</li>
</ul>
</li>
<li>Distance from first quartile to third quartile is the <a class="gl-ref" href="../glossary/#iqr" markdown="1">inter-quartile range</a><ul>
<li>Lower and upper lines cut off at 1.5$$\times$$IQR</li>
<li>Anything beyond that is considered an outlier and shown as a point</li>
</ul>
</li>
</ul>
<p title="version-other-plots.py"><div class="highlight"><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Releases&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s1">&#39;figures/release-count-box.svg&#39;</span><span class="p">)</span>
</code></pre></div></p>
<p>{% include figure
   id="release-count-box"
   img="figures/release-count-box.svg"
   cap="Box-and-Whisker Plot (Low End)"
   alt="FIXME"
   title="Symmetric vertical box plot with almost all values at low end." %}</p>
<h3>How should we structure data analysis projects?</h3>
<ul>
<li>Data analysis projects include programs and programming,
    but are not the same as software development projects</li>
<li>Starting point is Taschuk's Rules <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Taschuk2017">Taschuk2017</a>]</span><ol>
<li>Use version control.</li>
<li>Document your code and usage</li>
<li>Make common operations easy to control.</li>
<li>Version your releases.</li>
<li>Reuse software (within reason)</li>
<li>Rely on build tools and package managers for installation.</li>
<li>Do not require root or other special privileges to install or run.</li>
<li>Eliminate hard-coded paths.</li>
<li>Include a small test set that can be run to ensure the software is actually working.</li>
<li>Produce identical results when given identical inputs.</li>
</ol>
</li>
<li>The first three rules are the most important<ul>
<li>We assume you are already using version control</li>
</ul>
</li>
<li>Restructure our program</li>
</ul>
<h4>Main driver</h4>
<ul>
<li>The <a class="gl-ref" href="../glossary/#main_driver" markdown="1">main driver</a> lays out the overall flow of the program<ul>
<li>Parse command-line options</li>
<li>Set up</li>
<li>Produce output incrementally while processing data
    (rather than read-process-write)</li>
</ul>
</li>
<li>Include a <a class="gl-ref" href="../glossary/#docstring" markdown="1">docstring</a> for help</li>
</ul>
<p title="bin/get-all-versions.py"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Main driver.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">all_packages</span> <span class="o">=</span> <span class="n">get_package_list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">initialize_progress</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">all_packages</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">lineterminator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Package&#39;</span><span class="p">,</span> <span class="s1">&#39;Release&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">all_packages</span><span class="p">:</span>
        <span class="n">get_package_info</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
        <span class="n">report_progress</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>

<span class="c1"># ...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></p>
<ul>
<li>Uses the [<code>csv</code>][csv-py] package to format output instead of printing strings ourselves<ul>
<li>Takes care of <a class="gl-ref" href="../glossary/#escape_character" markdown="1">escaping</a> special characters</li>
</ul>
</li>
</ul>
<h4>Parse command-line arguments</h4>
<p title="bin/get-all-versons.py"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parse command-line arguments.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--restart&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;restart from this package&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;show progress&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</code></pre></div></p>
<ul>
<li>Use [<code>argparse</code>][argparse] to parse command-line arguments<ul>
<li><code>--verbose</code> to track progress (because it takes hours)</li>
<li><code>--restart</code> to start from a specified point because networks fail<ul>
<li>May result in redundant records</li>
<li>Definitely results in header appearing multiple times</li>
<li>Clean up afterward</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>Get the main package list</h4>
<p title="bin/get-all-versons.py"><div class="highlight"><pre><span></span><code><span class="c1"># Match package URL in main index page.</span>
<span class="n">RE_PACKAGE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;a href=&quot;(.+?)&quot;&gt;&#39;</span><span class="p">)</span>

<span class="c1"># ...</span>

<span class="k">def</span> <span class="nf">get_package_list</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get main package listing page and extract values.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span> \
        <span class="sa">f</span><span class="s1">&#39;Unexpected status for index page </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">all_packages</span> <span class="o">=</span> <span class="n">RE_PACKAGE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">all_packages</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">all_packages</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">restart</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">all_packages</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">restart</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unable to find </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">restart</span><span class="si">}</span><span class="s1"> in package list&#39;</span><span class="p">,</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">all_packages</span> <span class="o">=</span> <span class="n">all_packages</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">all_packages</span>
</code></pre></div></p>
<ul>
<li>Regular expression is at the top of the file with other "constants"<ul>
<li>Unfortunately no way to attach a docstring</li>
</ul>
</li>
<li>Get the main package listing page<ul>
<li>Fail if it can't be found rather than supporting restart</li>
<li>Slice here to get the package list</li>
</ul>
</li>
<li>Handle restart here as well (and fail if that isn't going to work)</li>
<li>Use <code>all_packages</code> rather than just <code>packages</code> as a name
    so that the code reads aloud more clearly<ul>
<li>Look at consistent variable naming in the exercises</li>
</ul>
</li>
</ul>
<h4>Get information about a single package</h4>
<p title="bin/get-all-versions.py"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_package_info</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get and print information about a specific package.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unexpected status for package page </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;NA&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_releases</span> <span class="o">=</span> <span class="n">RE_RELEASE</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">release</span> <span class="ow">in</span> <span class="n">all_releases</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">release</span><span class="p">])</span>
</code></pre></div></p>
<ul>
<li>Get packages one at a time<ul>
<li>Some attempts fail (status code is not 200)</li>
<li>Record these as <code>NA</code> rather than failing because we <em>can</em> proceed</li>
</ul>
</li>
</ul>
<h4>Report progress</h4>
<ul>
<li>Anything that takes long enough to worry about should tell users it's OK<ul>
<li>But that should be an option so that it <em>doesn't</em> ask for attention in a production pipeline</li>
</ul>
</li>
<li>Could initialize the record-keeping in <code>main</code>,
    but that function reads more cleanly if this low-level detail is hidden away</li>
<li>Goes to <code>sys.stderr</code> so that regular output can be redirected to file</li>
</ul>
<p title="bin/get-all-versions.py"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">initialize_progress</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">packages</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Initialize record keeping for progress monitoring.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;report&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
        <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
        <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">packages</span><span class="p">),</span>
        <span class="s1">&#39;seen&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">report_progress</span><span class="p">(</span><span class="n">progress</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Report progress, updating the progress record as a side effect.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">progress</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">]):</span>
        <span class="k">return</span>
    <span class="n">progress</span><span class="p">[</span><span class="s1">&#39;seen&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">progress</span><span class="p">[</span><span class="s1">&#39;seen&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">progress</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">progress</span><span class="p">[</span><span class="s1">&#39;expected&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">elapsed</span> <span class="o">/</span> <span class="n">progress</span><span class="p">[</span><span class="s1">&#39;seen&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">progress</span><span class="p">[</span><span class="s1">&#39;seen&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">progress</span><span class="p">[</span><span class="s1">&#39;expected&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</code></pre></div></p>
<h4>What's missing</h4>
<ul>
<li>This program does not have an option for output file<ul>
<li>Should probably have one option to create a new file and another to append to an existing file</li>
</ul>
</li>
<li>Should probably also have an option to stop trying if enough pages fail</li>
</ul>
<h3>What should go where?</h3>
<p>Noble's Rules are a way to organize small data analysis projects <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Noble2009">Noble2009</a>]</span>.
Each one lives in a separate Git repository
whose subdirectories are organized by purpose:</p>
<ul>
<li>
<p><code>src</code> (short for "source") holds source code
    for programs written in languages like C or C++ that need to be compiled.
    Many projects don't have this directory
    because all of their code is written in languages that don't need compilation.</p>
</li>
<li>
<p>Runnable programs go in <code>bin</code> (an old Unix abbreviation for "binary", meaning "not text").
    This includes the compiled and runnable versions of C and C++ programs,
    and also shell scripts,
    Python or R programs,
    and everything else that can be executed.</p>
</li>
<li>
<p>Raw data goes in in <code>data</code> and is never modified after being stored.</p>
</li>
<li>
<p>Results are put in <code>results</code>.
    This includes cleaned-up data
    and everything else that can be rebuilt using what's in <code>bin</code> and <code>data</code>.
    If intermediate results can be re-created quickly and easily,
    they might not be stored in version control,
    but anything that is included in a report should be here.</p>
</li>
<li>
<p>Finally,
    documentation and manuscripts go in <code>doc</code>.</p>
</li>
</ul>
<p>Documentation is often generated from source code,
and it's usually a bad idea to mix handwritten and machine-generated files,
so most projects now use separate subdirectories for software documentation (<code>doc</code>)
and reports (<code>reports</code> or <code>papers</code>).
People also often create a <code>figures</code> directory to hold generated figures
rather than putting them in <code>results</code>.</p>
<p>The directories in the top level of each project are organized by purpose,
but the directories within <code>data</code> and <code>results</code> are organized chronologically
so that it's easy to see when data was gathered and when results were generated.
These directories all have names in <a class="gl-ref" href="../glossary/#iso_date_format" markdown="1">ISO date format</a> like <code>YYYY-MM-DD</code>
to make it easy to sort them chronologically.
This naming is particularly helpful when data and results are used in several reports.</p>
<p>At all levels,
filenames should be easy to match with simple patterns.
For example,
a project might use <code><em>species</em><em><em>organ</em></em><em>treatment</em>.csv</code>
as a file-naming convention,
giving filenames like <code>human_kidney_cm200.csv</code>.
This allows <code>human_*_cm200.csv</code> to match all human organs
or <code>*_kidney_*.csv</code> to match all kidney data.
It does produce long filenames,
but tab completion means you only have to type them once.
Long filenames are just as easy to match in programs:
Python's [<code>glob</code>][glob] module will take a pattern and return a list of matching filenames.</p>
<h3>How should we keep track of our data?</h3>
<ul>
<li>Data should be published along with reports<ul>
<li>How else can people check or extend your work?</li>
</ul>
</li>
<li>Large datasets that are archived and maintained by trusted institutions (e.g., open government data)
    don't need to be stored<ul>
<li>Just include a link, a method for downloading, and a date</li>
</ul>
</li>
<li>If a report involves a new dataset:<ul>
<li>Always use <a class="gl-ref" href="../glossary/#tidy_data" markdown="1">tidy data</a>.</li>
<li>Include keywords describing the data in the project's <code>README.md</code>
    so that they appear on its home page and can easily be found by search engines.</li>
<li>Give every dataset and every report a unique identifier.</li>
<li>Use well-known formats like CSV and HDF5.</li>
<li>Include an explicit license.</li>
<li>Include units and other metadata.</li>
</ul>
</li>
</ul>
<p>The last point is often the hardest for people to implement,
since many researchers have never seen a well-documented dataset.
The <a class="gl-ref" href="../glossary/#data_manifest" markdown="1">data manifest</a> for <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Diehm2018">Diehm2018</a>]</span> is a good example;
each dataset is described by an entry like this:</p>
<div class="callout">
<ul>
<li>What is this?: This file contains all of the measurements for 80 pairs of blue jeans from the most popular and widely available brands in the US.</li>
<li>Source(s): All data was collected from manual measurements by Jan Diehm and Amber Thomas at brick and mortar stores in Nashville, New York, and Seattle.
    All measurements of front pockets were taken of the right-hand-side front pocket of empty jeans.</li>
<li>Last Modified: August 13, 2018</li>
<li>Contact Information: Amber Thomas</li>
<li>Spatial Applicability: United States</li>
<li>Temporal Applicability: All measurements were collected between June 29 and August 6, 2018</li>
<li>Observations (Rows): Each row represents data from a single pair of jeans.</li>
<li>Variables (Columns):</li>
</ul>
<table>
<thead>
<tr>
<th>Header</th>
<th>Datatype</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>brand</code></td>
<td>text</td>
<td>The full brand name.</td>
</tr>
<tr>
<td><code>style</code></td>
<td>text</td>
<td>The cut of each pair of jeans (in our analysis, we combined straight and boot-cut styles and skinny and slim styles, but these remain separated here).</td>
</tr>
<tr>
<td><code>menWomen</code></td>
<td>text</td>
<td>Whether the jeans were listed as "men's" or "women's".</td>
</tr>
<tr>
<td><code>name</code></td>
<td>text</td>
<td>The name of the specific style of measured pair of jeans as indicated by the tag. (e.g., <code>Fave Super Skinny Jean</code>).</td>
</tr>
<tr>
<td><code>brandSize</code></td>
<td>text</td>
<td>The size of jeans we measured. Each size reflects the sizing for each brand closest to a 32-inch waistband as indicated by the brand's website.</td>
</tr>
<tr>
<td><code>waistSize</code></td>
<td>number</td>
<td>The waistband size (in inches) of each measured pair as reported on the brand's website.</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
</tbody>
</table>
</div>
<div class="callout">
<h3>FAIR play</h3>
<p>The [FAIR Principles][fair-principles] <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Brock2019">Brock2019</a>]</span>
state that data should be <em>findable</em>, <em>accessible</em>, <em>interoperable</em>, and <em>reusable</em>.
They are still aspirational for most researchers,
but they tell us what to aim for.</p>
</div>
<h3>How should we keep track of our workflow?</h3>
<p>It's easy to run one program to process a single data file,
but what happens when our analysis depends on many files,
or when we need to re-do the analysis every time new data arrives?
What should we do if the analysis has several steps
that we have to do in a particular order?</p>
<p>If we try to keep track of this ourselves,
we will inevitably forget some crucial steps,
and it will be hard for other people to pick up our work.
Instead,
we should use a <a class="gl-ref" href="../glossary/#build_tool" markdown="1">build tool</a>
to keep track of what depends on what
and run our analysis programs automatically.
These tools were invented to help programmers rebuild complex software,
but can be used to automate any workflow.</p>
<div class="callout">
<h3>Make</h3>
<p>The first widely-used build tool, Make, written in 1976.  Programmers have
created many replacements for it in the decades since then—so many, in fact,
that none have attracted enough users to displace it entirely.</p>
</div>
<p>When Snakemake runs,
it reads <a class="gl-ref" href="../glossary/#build_rule" markdown="1">build rules</a> from a file called <code>Snakefile</code>.
(It can be called other things, but that's the convention.)
Each rule explains how to update a <a class="gl-ref" href="../glossary/#build_target" markdown="1">target</a>
if it is out of date compared to any of its <a class="gl-ref" href="../glossary/#build_prerequisite" markdown="1">prerequisites</a>.
Here's a rule to regenerate a compressed data file <code>data/all-versions.csv.gz</code>
if the file is older than the script used to create it:</p>
<div class="highlight"><pre><span></span><code><span class="n">rule</span> <span class="n">all_versions</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Download all version info from PyPI - takes several hours.&#39;&#39;&#39;</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="n">protected</span><span class="p">(</span><span class="s1">&#39;data/all-versions.csv.gz&#39;</span><span class="p">)</span>
    <span class="n">shell</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        python bin/get-all-versions.py &gt; data/all-versions.csv</span>
<span class="sd">        gzip data/all-versions.csv</span>
<span class="sd">        &#39;&#39;&#39;</span>
</code></pre></div>
<ul>
<li>First line gives the rule a meaningful name</li>
<li>Second is a docstring<ul>
<li><code>snakemake --list</code> will show the rules and their docstrings</li>
</ul>
</li>
<li><code>output</code> section tells Snakemake what file(s) this rule produces<ul>
<li>The <code>protected</code> function tells Snakemake to change permissions on the file so it won't accidentally be deleted</li>
<li>Only do this for files that take a long time to re-create</li>
</ul>
</li>
<li><code>shell</code> section tells Snakemake what command(s) to run to create the output<ul>
<li>It will automatically create the <code>data</code> directory if need be</li>
<li>We can put Python directly in the Snakefile, but I prefer scripts so that commands can be re-run independently</li>
</ul>
</li>
</ul>
<div class="callout">
<h4>Compressing Data</h4>
<p>Compressing this dataset takes file from 103.8 Mbyte to 9.5 Mbyte, which is
almost a factor of 11.  However, version control can only diff and merge plain
text files, so if the file is compressed, Git can't help us track changes to
individual lines.  On the other hand we probably shouldn't be changing a dataset
anyway...</p>
</div>
<ul>
<li>Execute these commands with</li>
</ul>
<div class="highlight"><pre><span></span><code>snakemake -j <span class="m">1</span> all_versions
</code></pre></div>
<p>Since that will take several hours to complete,
let's add another rule to the same file:</p>
<div class="highlight"><pre><span></span><code><span class="n">rule</span> <span class="n">releases_per_package</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;How many releases are there for each package?&#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s1">&#39;data/all-versions.csv.gz&#39;</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s1">&#39;results/releases.csv&#39;</span>
    <span class="n">shell</span><span class="p">:</span>
        <span class="s1">&#39;python bin/count-releases.py </span><span class="si">{input}</span><span class="s1"> &gt; </span><span class="si">{output}</span><span class="s1">&#39;</span>
</code></pre></div>
<ul>
<li><code>-j1</code> means "only run one job at a time"<ul>
<li>Snakemake can run many jobs in parallel</li>
</ul>
</li>
<li><code>results/releases.csv</code> depends on an input data file</li>
<li>Snakemake only runs the commands if the output doesn't exist or is older than the input</li>
</ul>
<p><code>count-releases.py</code> is only a few lines long.
It takes advantage of the fact that if we give Pandas' <code>read_csv</code> function
a string instead of a stream
it assumes that parameter is a filename,
and that it can read directly from compressed files
(which it identifies by looking for common endings like <code>.zip</code> or <code>.gz</code>).</p>
<p title="bin/count-releases.py"><div class="highlight"><pre><span></span><code><span class="c1"># !/usr/bin/env python</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Count how many releases there are per package.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Main driver.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Package&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">result</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></p>
<p>If we run:</p>
<div class="highlight"><pre><span></span><code>snakemake -j1 releases_per_package
</code></pre></div>
<p>and wait a few seconds,
we have a file with the following:</p>
<div class="highlight"><pre><span></span><code>Package,Release
0,1
0-0-1,1
0-core-client,9
0-orchestrator,14
00print-lol,2
01d61084-d29e-11e9-96d1-7c5cf84ffe8e,2
021,1
...
</code></pre></div>
<p>Creating a Snakefile may seem like extra work,
but few things in life are as satisfying as running one command
and watching an entire multi-step analysis run itself:</p>
<ol>
<li>
<p>It reduces errors,
    since we only have to type commands correctly once
    instead of over and over again.</p>
</li>
<li>
<p>More importantly,
    it documents our workflow
    so that someone else (including our future self)
    can see exactly what steps we used in what order.</p>
</li>
</ol>
<h3>How can we remove redundant releases?</h3>
<ul>
<li>How many packages are released in redundant formats (e.g., as both <code>.tar.gz</code> and <code>.whl</code>)?</li>
<li>First step is to find out what formats are represented in the data<ul>
<li>Break names on <code>.</code></li>
<li>Count how often each type of field appears</li>
</ul>
</li>
</ul>
<p title="bin/components.py"><div class="highlight"><pre><span></span><code><span class="c1"># !/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Count frequency of &#39;.&#39;-separated components of names.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Release&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;Component&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Count&#39;</span><span class="p">})</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Component&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d+$&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></p>
<ul>
<li>
<p>In order:</p>
<ul>
<li>Read the file</li>
<li>Split the <code>Release</code> column on <code>.</code>, creating new columns for the fragments</li>
<li>Flatten all those columns into a single vector</li>
<li>Count how often each component appears</li>
<li>Remove the <code>None</code> value (because splitting on <code>.</code> created a lot of blanks)</li>
<li>Turn the result back into a dataframe and reset the index<ul>
<li>We explore why we need to reset the index in the exercises</li>
</ul>
</li>
<li>Give the columns sensible names</li>
<li>Keep values that aren't composed entirely of digits (after inspection)</li>
<li>Sort by count</li>
<li>Save</li>
</ul>
</li>
<li>
<p>We did <em>not</em> write this all at once</p>
<ul>
<li>Write the first couple of steps</li>
<li><code>gunzip -c data/all-versions.csv | head -n 10 &gt; /tmp/test-data.csv.gz</code> to create a test dataset</li>
<li>Keep adding steps</li>
<li>Enlarge the test set once the pipeline seems to be working</li>
</ul>
</li>
<li>
<p>Add a rule to <code>Snakefile</code></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nf">rule count_name_components</span><span class="o">:</span>
    <span class="s1">&#39;&#39;&#39;How often does each component of a dotted name occur?&#39;&#39;&#39;</span>
    input:
        <span class="s1">&#39;data/all-versions.csv.gz&#39;</span>
    output:
        <span class="s1">&#39;results/name-component-count.csv&#39;</span>
    shell:
        <span class="s1">&#39;python bin/components.py {input} &gt; {output}&#39;</span>
</code></pre></div>
<ul>
<li>Run</li>
</ul>
<div class="highlight"><pre><span></span><code>Component,Count
tar,1298365
gz,1294773
whl,833181
py3-none-any,219230
egg,83174
zip,79232
0-py2,56429
0-py3-none-any,53955
1-py3-none-any,46384
1-py2,42507
2-py3-none-any,29974
2-py2,27282
3-py3-none-any,21383
3-py2,19175
exe,17161
0-py2-none-any,16079
4-py3-none-any,15782
4-py2,14105
5-py3-none-any,12791
1-py2-none-any,11683
5-py2,11233
...
</code></pre></div>
<ul>
<li>
<p>Most common suffixes are <code>.tar.gz</code>, <code>.tar</code>, <code>.whl</code>, <code>.egg</code>, <code>.zip</code>, and <code>.exe</code></p>
<ul>
<li>Need domain knowledge to recognize these</li>
<li>And to know that <code>.tar</code> and <code>.gz</code> appear together</li>
</ul>
</li>
<li>
<p>Add this rule at the top of the file</p>
<ul>
<li>Depends on two files but doesn't have an action</li>
<li>Snakemake re-creates both files</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Dummy rule to rebuild everything.&#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="p">[</span><span class="s1">&#39;results/releases.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;results/name-component-count.csv&#39;</span><span class="p">]</span>
</code></pre></div>
<ul>
<li>Next, calculate how many releases there are per package once we remove duplicates</li>
</ul>
<p title="bin/remove-duplicates.py"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Count releases before and after de-duplication.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">num_packages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Stripped</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Release&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.(tar\.gz|tar|whl|egg|zip|exe)$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Complete&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Package&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
                           <span class="s1">&#39;Stripped&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Package&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Stripped</span><span class="o">.</span><span class="n">nunique</span><span class="p">()})</span>
    <span class="n">num_shorter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">Complete</span> <span class="o">&gt;</span> <span class="n">result</span><span class="o">.</span><span class="n">Stripped</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_shorter</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">num_packages</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">num_shorter</span> <span class="o">/</span> <span class="n">num_packages</span><span class="p">)</span><span class="si">:</span><span class="s1">6.2</span><span class="si">}</span><span class="s1">%) shorter&#39;</span><span class="p">)</span>
</code></pre></div></p>
<ul>
<li>Rule in Snakefile doesn't produce an output file<ul>
<li>Just shows us</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">rule</span> <span class="n">count_redundant_releases</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;How many duplicated (redundant) releases are there?&#39;&#39;&#39;</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s1">&#39;data/all-versions.csv.gz&#39;</span>
    <span class="n">shell</span><span class="p">:</span>
        <span class="s1">&#39;python bin/remove-duplicates.py data/all-versions.csv.gz&#39;</span>
</code></pre></div>
<ul>
<li>Output</li>
</ul>
<div class="highlight"><pre><span></span><code>2255 / 2312545 ( 0.098%) shorter
</code></pre></div>
<ul>
<li>So this <em>isn't</em> a big enough issue to explain the even-numbered jagginess of our earlier figure</li>
</ul>
<h2 class="scraper-exercises">Exercises</h2>
<p>FIXME</p>
<ol>
<li>
<p>Write a program to count the number of tables in <code>table.html</code>.</p>
</li>
<li>
<p>Write a program that combines all the information from tables with the class <code>species</code>
    into a single CSV file.</p>
</li>
<li>
<p>Write a program that produces a plain-text table of contents,
    using indentation to show nesting:</p>
<div class="highlight"><pre><span></span><code>Species Information
  Water Birds
  Loons
  Details
</code></pre></div>
</li>
</ol>
        </main>
      </div>
    </div>
  </body>
</html>
